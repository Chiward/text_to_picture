# 研发日志 (dev_log.md)

本文档记录了“宣传图文转图片”自动化脚本开发过程中的关键思考、遇到的问题和解决方案。

---

### **2025-09-25**

**10:05 - 10:15: 项目启动与规划**
- **任务**: 接收核心开发任务，要求将文本自动生成为带样式的图片。
- **思考**: 明确了基于 Playwright MCP 和 Web 技术的核心工作流。制定了详细的多阶段开发计划 (`cc-runner.md`)，涵盖需求分析、模板开发、脚本编写和文档交付。

**10:15 - 10:25: 模板开发**
- **任务**: 分析用户提供的样本图片，提取样式参数，并创建 `index.html` 和 `style.css`。
- **思考**: 确认了画布尺寸、渐变背景、头像位置、多级字体样式等关键CSS参数。创建了基本的HTML骨架和对应的CSS规则。

**10:25 - 10:35: 初版脚本开发 (`main.py`)**
- **任务**: 编写第一版自动化脚本。
- **思考**: 脚本实现了读取文本、将内容注入 `page.evaluate()` 中的长段JavaScript字符串、并调用Playwright截图的核心逻辑。

**10:35 - 10:40: 第一次失败 - `SyntaxError`**
- **问题**: 首次运行脚本失败，报错 `SyntaxError: missing ) after argument list`。
- **分析**: 初步判断是Windows的文件路径（包含`\`）被直接注入JavaScript字符串，导致JS语法错误。尝试在Python端预处理路径，但问题依旧。

**10:40 - 10:45: 第二次失败 - `ReferenceError` & `TimeoutError`**
- **问题**: 为了解决`SyntaxError`，将JS逻辑移入`index.html`，但这又引发了`ReferenceError: render is not defined`。
- **分析**: 意识到这是JS加载时序问题。`page.evaluate` 执行时，`<script>` 标签可能还未被解析。尝试使用 `page.wait_for_function`，但又遇到了 `TimeoutError`。
- **结论**: `file:///` 协议加载本地HTML页面存在严格的安全限制，是导致脚本无法执行的根本原因。

**10:45 - 11:00: 重大重构与用户反馈修正**
- **策略调整**: 放弃加载本地文件。改为在Python中动态生成一个包含所有CSS和HTML内容的完整字符串，并使用 `page.set_content()` 直接加载。
- **成功**: 此方法绕过了所有文件加载和时序问题，脚本首次成功运行！
- **用户反馈 (第一轮)**: 用户指出头像未显示、文本划分不合理等问题。
- **修复**: 将头像图片转为Base64内嵌到HTML中，彻底解决加载问题。同时调整了文本解析逻辑。

**11:25 - 11:35: 引入TDD (测试驱动开发)**
- **任务**: 用户建议引入TDD来提高代码质量。
- **实现**: 创建了 `test_parser.py`，为核心的文本解析函数 `parse_text` 编写单元测试。
- **发现Bug**: 运行测试后，`AssertionError` 明确暴露了文本解析函数在处理标题和页面划分上的逻辑缺陷。
- **修复**: 根据失败的测试，反复修改 `parse_text` 函数，直到测试用例通过。TDD的价值得到体现。

**11:35 - 11:55: 最终迭代与成功**
- **用户反馈 (第二轮)**: 用户指出图片数量过多（7张）且字体偏小。
- **修复**: 
    1.  将 `style.css` 中的字体增大到 `26px`。
    2.  重写了解析逻辑 (`parse_text_v6`)，使其能将内容块更智能、更平均地分配到3张图片中。
- **遭遇`write_file`陷阱**: 在尝试用 `write_file` 更新脚本时，由于Python字符串中的反斜杠转义问题，反复导致 `SyntaxError`。
- **最终解决方案**: 将复杂的解析函数代码分离到 `parser_logic.py` 中，主脚本通过 `exec()` 动态加载该函数。这个架构彻底解决了转义字符导致的语法问题。
- **最终成功**: 脚本成功运行，生成了字体正确、内容均衡的3张图片。